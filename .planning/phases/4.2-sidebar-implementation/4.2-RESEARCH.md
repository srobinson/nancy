<!-- b_path:: .planning/phases/4.2-sidebar-implementation/4.2-RESEARCH.md -->
# Phase 4.2: Sidebar Implementation - Research

**Researched:** 2026-01-15
**Domain:** tmux pane management with stable pane IDs
**Confidence:** HIGH (all patterns tested in live tmux session)

<research_summary>
## Summary

Research focused on fixing the POC v6 failures. The core problem was using pane **indices** which shift when panes are added/removed. The solution is using stable pane **IDs**.

**Critical corrections from prior research:**
1. DON'T use `break-pane -t` to move to existing windows - it creates new windows only
2. USE `join-pane` for ALL pane movements between windows
3. Store pane IDs at creation (`%42` format), use them directly
4. Windows are destroyed when empty - must recreate before joining to them
5. Use horizontal split (`-h`) when joining to hidden to avoid "pane too small" errors

**Working POC:** `TMP/sidebar-poc-v7.sh` - passes full cycle test (1→2→3→1→2→3→1)

**Primary recommendation:** Implement using pane ID registry pattern from v7 POC.
</research_summary>

<standard_stack>
## Standard Stack

### Core (No External Dependencies)
| Tool | Version | Purpose | Notes |
|------|---------|---------|-------|
| tmux | 3.0+ | Terminal multiplexer | All features available |
| bash | 5.x | Shell scripting | Already in use |

### tmux Features Used (Verified)
| Feature | Command | Tested |
|---------|---------|--------|
| Pane ID capture | `display-message -p '#{pane_id}'` | YES |
| State storage | `set-option -g @key VAL` | YES |
| State retrieval | `show-option -gqv @key` | YES |
| Join pane | `join-pane -h -s PANE_ID -t TARGET` | YES |
| Resize pane | `resize-pane -t PANE_ID -x 20` | YES |
| List windows | `list-windows -F '#{window_name}'` | YES |
| Create window | `new-window -d -t session -n name` | YES |
| Split before | `split-window -hb -l 20%` | YES |

### What NOT to Use (Verified Failures)
| Command | Why Not | Error |
|---------|---------|-------|
| `break-pane -t existing_window` | Creates new window, fails if index exists | "index in use: N" |
| Pane indices (`.1`, `.2`) | Shift when panes change | Wrong pane targeted |
| `join-pane -v` to hidden | Vertical splits run out of space | "pane too small" |
| `new-window -n name ''` | Empty string doesn't create window | Silent failure |
</standard_stack>

<architecture_patterns>
## Architecture Patterns

### Pattern: Pane ID Registry (Verified)

Store pane IDs at creation time, use them for all operations.

```bash
# At creation time - capture and store pane ID
AGENT1_ID=$(tmux display-message -p -t "${SESSION}:hidden.1" '#{pane_id}')
tmux set-option -g "@${SESSION}-agent1" "$AGENT1_ID"

# Later - retrieve and use directly
agent1_id=$(tmux show-option -gqv "@${SESSION}-agent1")
tmux join-pane -h -s "$agent1_id" -t "${SESSION}:main.1"
```

**Why this works:** Pane IDs (like `%183`) are stable for the entire tmux server session. They never change or get reused.

### Pattern: Ensure Window Exists (Verified)

Windows are automatically destroyed when their last pane is removed.

```bash
ensure_window() {
    local session="$1"
    local name="$2"
    if ! tmux list-windows -t "$session" -F '#{window_name}' 2>/dev/null | grep -q "^${name}$"; then
        tmux new-window -d -t "$session" -n "$name"
        return 0
    fi
    return 1
}

# Usage before join-pane
ensure_window "$SESSION" "hidden" || true
tmux join-pane -h -s "$PANE_ID" -t "${SESSION}:hidden"
```

### Pattern: Switch Agent (Verified Working)

```bash
switch_agent() {
    local new_agent="$1"
    local current=$(tmux show-option -gqv "@${SESSION}-active")

    [[ "$new_agent" == "$current" ]] && return  # Already showing

    # Get pane IDs from registry
    local current_id=$(tmux show-option -gqv "@${SESSION}-agent${current}")
    local new_id=$(tmux show-option -gqv "@${SESSION}-agent${new_agent}")
    local sidebar_id=$(tmux show-option -gqv "@${SESSION}-sidebar")

    # Ensure hidden window exists
    ensure_window "$SESSION" "hidden" || true

    # Move current to hidden (horizontal split!)
    tmux join-pane -h -s "$current_id" -t "${SESSION}:hidden"

    # Move new to main
    tmux join-pane -h -s "$new_id" -t "${SESSION}:main.1"

    # Restore sidebar width
    tmux resize-pane -t "$sidebar_id" -x 20

    # Update state
    tmux set-option -g "@${SESSION}-active" "$new_agent"
}
```

### Anti-Patterns (Verified Failures)

| Anti-Pattern | What Happens | Use Instead |
|--------------|--------------|-------------|
| `break-pane -t hidden` | "index in use: 2" error | `join-pane -s ID -t hidden` |
| Pane index math | Wrong pane after operations | Store and use pane IDs |
| `join-pane -v` to hidden | "pane too small" after many switches | `join-pane -h` |
| Assume window exists | "can't find window" error | `ensure_window` helper |
</architecture_patterns>

<dont_hand_roll>
## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why (Tested) |
|---------|-------------|-------------|--------------|
| Pane targeting | Index calculation | Pane IDs (`%42`) | Indices shift, IDs don't |
| State persistence | File-based state | `tmux set-option -g @key` | Survives reconnects |
| Window existence | Assume it exists | `list-windows` + grep check | Windows auto-destroy |
| Pane movement | `break-pane -t` | `join-pane -s ID -t target` | break-pane creates windows |

**Key insight:** The POC v6 failure was trying to use `break-pane -t hidden` which tries to CREATE a window, not add to one. `join-pane` is the correct command for moving between windows.
</dont_hand_roll>

<common_pitfalls>
## Common Pitfalls (All Verified)

### Pitfall 1: break-pane vs join-pane
**What goes wrong:** `break-pane -t existing_window` fails with "index in use: N"
**Why it happens:** `break-pane` creates a NEW window; `-t` specifies the window INDEX to create
**Actual error:** `index in use: 2`
**Solution:** Use `join-pane -s pane_id -t window` for moving between windows

### Pitfall 2: Pane Index Shifting
**What goes wrong:** After operations, `${SESSION}:hidden.1` points to wrong pane
**Why it happens:** Indices renumber when panes are added/removed
**Solution:** Store pane IDs at creation, use them directly: `join-pane -s %183`

### Pitfall 3: Hidden Window Auto-Destruction
**What goes wrong:** `can't find window: hidden`
**Why it happens:** tmux destroys windows when their last pane is removed
**Solution:** Check and create window before joining: `ensure_window "$SESSION" "hidden"`

### Pitfall 4: Vertical Split Exhaustion
**What goes wrong:** `create pane failed: pane too small`
**Why it happens:** Using `-v` (vertical) when joining to hidden exhausts vertical space
**Solution:** Use `-h` (horizontal) when joining to hidden window

### Pitfall 5: ensure_window Return Code
**What goes wrong:** Script exits on `ensure_window` when window exists
**Why it happens:** Function returns 1 when window exists, `set -e` treats as error
**Solution:** Call with `|| true`: `ensure_window "$SESSION" "hidden" || true`
</common_pitfalls>

<code_examples>
## Code Examples (All Tested)

### Capture Pane ID at Creation
```bash
# Tested: 2026-01-15
tmux send-keys -t "${SESSION}:hidden" "agent_command" Enter
AGENT_ID=$(tmux display-message -p -t "${SESSION}:hidden.1" '#{pane_id}')
# AGENT_ID is now something like "%183"
tmux set-option -g "@${SESSION}-agent1" "$AGENT_ID"
```

### Retrieve and Use Pane ID
```bash
# Tested: 2026-01-15
agent_id=$(tmux show-option -gqv "@${SESSION}-agent1")
# Use directly - no session:window prefix needed
tmux join-pane -h -s "$agent_id" -t "${SESSION}:main.1"
```

### Check Window Exists
```bash
# Tested: 2026-01-15
ensure_window() {
    local session="$1"
    local name="$2"
    if ! tmux list-windows -t "$session" -F '#{window_name}' 2>/dev/null | grep -q "^${name}$"; then
        tmux new-window -d -t "$session" -n "$name"
        return 0
    fi
    return 1
}
```

### Create Sidebar Layout
```bash
# Tested: 2026-01-15
# Creates sidebar (20%) on LEFT, main area (80%) on RIGHT
tmux split-window -t "$SESSION" -hb -l 20%
# -h = horizontal (side by side)
# -b = before (new pane goes LEFT)
# -l 20% = new pane is 20% width
```

### Complete Working POC
See: `TMP/sidebar-poc-v7.sh`
- Full cycle test passes: 1→2→3→1→2→3→1
- All patterns verified working
</code_examples>

<sota_updates>
## State of the Art (2025-2026)

No major changes to tmux pane management. The patterns discovered are stable:

| Pattern | Status | Notes |
|---------|--------|-------|
| Pane IDs (`%N`) | Stable | Always available, never reused |
| tmux options (`@key`) | Stable | Best for state storage |
| join-pane | Stable | Correct command for moving panes |
| break-pane | Stable | Only for creating new windows |

**From tmux-sidebar plugin:**
- Uses pane IDs stored in tmux options
- Uses `kill-pane` to remove sidebar (not hide)
- Validates pane width before operations
</sota_updates>

<open_questions>
## Open Questions

1. **Dynamic agent creation at runtime?**
   - Current: Create all agents upfront
   - Solution: Create pane in hidden, capture ID, add to registry
   - Not tested, but pattern should work

2. **Session name collisions?**
   - Current: Fixed session name "sidebar-v7"
   - Production: Use PID or timestamp in name
   - Easy to implement

3. **More than 3 agents?**
   - Pattern should scale - tested with 3
   - Hidden window uses horizontal splits, won't run out of space
</open_questions>

<sources>
## Sources

### Primary (HIGH confidence - tested)
- Live tmux testing (2026-01-15) - all patterns executed
- `TMP/sidebar-poc-v7.sh` - working implementation
- `TMP/test-pane-ids.sh` - pane ID validation
- `TMP/test-break-pane.sh` - break-pane vs join-pane discovery
- `TMP/test-correct-pattern.sh` - full switch pattern validation
- `TMP/test-window-lifecycle.sh` - window auto-destruction verification

### Secondary (MEDIUM confidence - official docs)
- [tmux wiki - Advanced Use](https://github.com/tmux/tmux/wiki/Advanced-Use) - pane ID documentation
- [tmux man page](https://man7.org/linux/man-pages/man1/tmux.1.html) - command syntax
- [tmux-sidebar source](https://github.com/tmux-plugins/tmux-sidebar) - state management pattern

### Superseded
- `4.1-RESEARCH-v2.md` - suggested `break-pane`, which was WRONG
- `TMP/sidebar-poc.sh` (v6) - used indices, which was fragile
</sources>

<metadata>
## Metadata

**Research scope:**
- Core: tmux pane IDs, join-pane vs break-pane
- Pattern: Pane ID registry for reliable operations
- Gap: break-pane doesn't add to existing windows (CRITICAL)
- Gap: Windows auto-destroy when empty

**Confidence breakdown:**
- Pane ID usage: HIGH - tested, works
- join-pane for moves: HIGH - tested, works
- Window lifecycle: HIGH - tested, verified
- Switch pattern: HIGH - full cycle test passes

**Test artifacts:**
- `TMP/sidebar-poc-v7.sh` - working POC
- `TMP/test-*.sh` - individual test scripts

**Research date:** 2026-01-15
**Corrections to:** 4.1-RESEARCH-v2.md (break-pane was wrong)
**Ready for planning:** YES
</metadata>

---

*Phase: 4.2-sidebar-implementation*
*Research completed: 2026-01-15*
*Ready for planning: yes*
