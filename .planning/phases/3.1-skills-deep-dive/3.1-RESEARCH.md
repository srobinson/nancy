<!-- b_path:: .planning/phases/3.1-skills-deep-dive/3.1-RESEARCH.md -->
# Phase 3.1: Skills Deep Dive - Research

**Researched:** 2026-01-13
**Domain:** Claude Code skill authoring, discovery, and optimization
**Confidence:** HIGH

<research_summary>
## Summary

Researched Claude Code skill internals to understand why some Nancy skills (check-tokens, session-history) aren't being recognized or triggered reliably. The core discovery mechanism uses YAML frontmatter `name` and `description` fields injected into the system prompt, with a **15,000 character budget** for all skill descriptions combined.

Key finding: Skills not triggering is often caused by (1) multi-line YAML descriptions breaking the parser, (2) exceeding the character budget, or (3) vague descriptions that don't trigger semantic matching. The filename SKILL.md (uppercase) is correct per Anthropic's official repo.

**Primary recommendation:** Audit all Nancy skills for single-line descriptions, trigger-rich language, and total character budget. Use `SLASH_COMMAND_TOOL_CHAR_BUDGET=30000` if needed.
</research_summary>

<standard_stack>
## Standard Stack

### File Structure (Required)
| Component | Requirement | Purpose |
|-----------|-------------|---------|
| SKILL.md | Required, uppercase | Main skill file |
| YAML frontmatter | Required at top | Metadata for discovery |
| `name` field | Required, max 64 chars | Lowercase, hyphens only |
| `description` field | Required, max 1024 chars | Primary trigger mechanism |

### Directory Structure
```
skill-name/
├── SKILL.md           # Required - core instructions
├── scripts/           # Optional - executable Python/Bash
├── references/        # Optional - docs loaded on demand
└── assets/            # Optional - templates, files for output
```

### Skill Locations (Claude Code)
| Location | Scope | Discovery |
|----------|-------|-----------|
| `~/.claude/skills/` | User-global | All projects |
| `.claude/skills/` | Project | Current project only |
| `~/.claude/commands/` | User-global | Slash commands |
| `.claude/commands/` | Project | Slash commands |

### YAML Frontmatter Requirements
```yaml
---
name: skill-name
# prettier-ignore
description: Single-line description of what the skill does and when to use it. Be specific about triggers.
---
```

**CRITICAL**: Description MUST be single-line. Multi-line YAML breaks Claude Code's parser.
</standard_stack>

<architecture_patterns>
## Architecture Patterns

### Pattern 1: Progressive Disclosure
**What:** Three-level loading system to manage context efficiently
**When to use:** Always - this is how skills work

1. **Metadata layer** (~100 tokens): `name` + `description` always in system prompt
2. **SKILL.md body** (<5k words): Loaded ONLY when skill triggers
3. **Bundled resources** (unlimited): Loaded only as needed by Claude

### Pattern 2: Trigger-Rich Descriptions
**What:** Include specific phrases that match user intent
**When to use:** All skills - description is PRIMARY trigger mechanism

**Good example:**
```yaml
description: Extract and analyze text from PDF files, fill forms, merge documents. Use when working with PDF files or when the user mentions PDFs, forms, or document extraction.
```

**Bad example:**
```yaml
description: Helps with documents
```

### Pattern 3: Reference File Organization
**What:** Keep SKILL.md lean, put details in separate files
**When to use:** When SKILL.md approaches 500 lines

```
skill-name/
├── SKILL.md           # Overview + navigation (<500 lines)
└── references/
    ├── domain-a.md    # Details for domain A
    └── domain-b.md    # Details for domain B
```

### Anti-Patterns to Avoid
- **Multi-line YAML descriptions:** Breaks Claude Code parser even if valid YAML
- **Vague descriptions:** "Helps with X" doesn't trigger - be specific
- **Too many skills:** 15,000 char budget for ALL descriptions combined
- **Nested references:** Keep references one level deep from SKILL.md
- **"When to use" in body:** Too late - only description triggers skills
</architecture_patterns>

<dont_hand_roll>
## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Skill not recognized | Debug manually | Check YAML is single-line | Prettier breaks multi-line descriptions |
| Too many skills | Combine into one | `SLASH_COMMAND_TOOL_CHAR_BUDGET=30000` | Budget is 15k chars default |
| Complex workflows | Long SKILL.md | Split into references/ files | Progressive disclosure |
| Triggering issues | Aggressive description hacks | Semantic trigger words | Description is primary mechanism |

**Key insight:** Skills are NOT discovered by Claude searching files. The `name` and `description` are INJECTED into the system prompt at startup. If they're not in the system prompt, Claude literally doesn't know they exist.
</dont_hand_roll>

<common_pitfalls>
## Common Pitfalls

### Pitfall 1: Multi-line YAML Descriptions
**What goes wrong:** Skill not recognized despite valid YAML
**Why it happens:** Prettier reformats to multi-line; Claude Code parser fails
**How to avoid:** Add `# prettier-ignore` before description, keep single-line
**Warning signs:** Skill appears in `/skills` but Claude never uses it

### Pitfall 2: Character Budget Exceeded
**What goes wrong:** Skills silently dropped from system prompt
**Why it happens:** Total descriptions exceed 15,000 char budget (default)
**How to avoid:** Keep descriptions concise; use `SLASH_COMMAND_TOOL_CHAR_BUDGET=30000`
**Warning signs:** Newer skills don't trigger; older skills still work

### Pitfall 3: Vague Descriptions
**What goes wrong:** Skill exists but Claude doesn't invoke it
**Why it happens:** Description doesn't match user intent semantically
**How to avoid:** Include specific trigger words and use cases
**Warning signs:** Must explicitly say "use the X skill" to trigger

### Pitfall 4: "When to Use" in Body
**What goes wrong:** Skill triggers but Claude didn't know when to use it
**Why it happens:** Body loads AFTER triggering - too late for discovery
**How to avoid:** ALL trigger info goes in description field
**Warning signs:** Skill works when invoked but Claude never auto-invokes

### Pitfall 5: Third-Person Description
**What goes wrong:** Inconsistent point-of-view confuses discovery
**Why it happens:** Description injected into system prompt as-is
**How to avoid:** Write descriptions in third person: "Processes X" not "I can help with X"
**Warning signs:** Erratic triggering behavior
</common_pitfalls>

<code_examples>
## Code Examples

### Minimal Working Skill
```yaml
---
name: my-skill
# prettier-ignore
description: Does X when user asks about Y. Use for Z tasks involving A, B, or C.
---

# My Skill

Instructions here.
```
Source: Verified from anthropic-skills repo + Scott Spence fix

### Check Environment Variable Budget
```bash
# Check current budget (if set)
echo $SLASH_COMMAND_TOOL_CHAR_BUDGET

# Launch Claude Code with increased budget
SLASH_COMMAND_TOOL_CHAR_BUDGET=30000 claude
```
Source: [fsck.com blog](https://blog.fsck.com/2025/12/17/claude-code-skills-not-triggering/)

### Effective Description Pattern
```yaml
description: Monitor context window token usage during worker turns. Use at turn start, periodically during long tasks, when approaching context limits, or when user asks about tokens.
```
Source: Anthropic best practices - trigger-rich description

### Reference File Pattern
```markdown
# SKILL.md (lean overview)

## Quick Start
[Basic usage]

## Advanced
- **Form handling:** See [forms.md](forms.md)
- **API details:** See [reference.md](reference.md)
```
Source: anthropic-skills/pdf/SKILL.md
</code_examples>

<sota_updates>
## State of the Art (2025-2026)

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| skill.md (lowercase) | SKILL.md (uppercase) | Always | Official standard |
| Multi-line descriptions | Single-line + prettier-ignore | 2025 discovery | Fixes recognition bugs |
| Unlimited skills | 15k char budget | Claude Code 2.0.70 | Must be concise |
| Body-based triggers | Description-only triggers | Always | Move trigger info to description |

**New tools/patterns to consider:**
- `SLASH_COMMAND_TOOL_CHAR_BUDGET` env var: Double the budget when needed
- `# prettier-ignore`: Prevent YAML reformatting
- Progressive disclosure: Split large skills into reference files

**Known bugs (as of Jan 2026):**
- `/skills` shows all skills but some may be excluded from system prompt due to budget
- GitHub issue #9716, #11266, #14733: Skills not auto-discovered (open issues)
- No warning when character budget exceeded
</sota_updates>

<open_questions>
## Open Questions

1. **Exact character budget calculation**
   - What we know: Default is 15,000 chars for skill descriptions
   - What's unclear: Is this shared with commands? Exact formula?
   - Recommendation: Monitor total description length, use env var if issues

2. **Case sensitivity of SKILL.md**
   - What we know: Anthropic uses SKILL.md, some sources say either works
   - What's unclear: Is lowercase skill.md actually supported?
   - Recommendation: Use SKILL.md (uppercase) to match official examples

3. **Why some skills trigger and others don't**
   - What we know: Description quality matters, budget matters
   - What's unclear: Exact semantic matching algorithm
   - Recommendation: Use explicit trigger words, test with real prompts
</open_questions>

<nancy_skill_audit>
## Nancy Skills Audit

### Current Skills Status

| Skill | Lines | Chars | Description Quality | Issue |
|-------|-------|-------|---------------------|-------|
| check-directives | 44 | 911 | Good | Working |
| send-message | 19 | 441 | Good | Working |
| check-tokens | 22 | 969 | Needs improvement | Missing trigger words |
| session-history | 63 | 2179 | Needs improvement | Missing trigger words |
| create-spec | 55 | 1043 | Needs review | - |
| orchestrator | 46 | 1030 | Needs review | - |
| update-spec | 20 | 360 | Needs review | - |

**Total character count:** ~7,000 (well under 15k budget)

### Recommended Improvements

**check-tokens:**
```yaml
# Current
description: Monitor context window token usage during Nancy worker turns. Use at turn start and periodically during long tasks to avoid context overflow

# Improved
description: Monitor context window token usage. Use at turn start, after major tasks, when context feels full, or when user asks about tokens or context usage. Essential for avoiding context overflow.
```

**session-history:**
```yaml
# Current
description: MUST USE for any request about sessions. TRIGGERS: continue from previous session, what did we do, search sessions, summarize session. Do NOT manually search session files

# Improved (third-person, trigger-rich)
description: Access CLI session history for continuing work, summarizing conversations, or searching past sessions. Triggers on: continue from last session, what did we do, search sessions, summarize session, session history.
```
</nancy_skill_audit>

<sources>
## Sources

### Primary (HIGH confidence)
- [Anthropic Skills Repo](https://github.com/anthropics/skills) - Official examples and patterns
- [Skill authoring best practices](https://platform.claude.com/docs/en/agents-and-tools/agent-skills/best-practices) - Official documentation
- [Creating custom skills](https://support.claude.com/en/articles/12512198-creating-custom-skills) - Official guide

### Secondary (MEDIUM confidence)
- [Scott Spence - Claude Code Skills Not Recognised](https://scottspence.com/posts/claude-code-skills-not-recognised) - Verified fix for multi-line YAML issue
- [fsck.com - Skills not triggering](https://blog.fsck.com/2025/12/17/claude-code-skills-not-triggering/) - Character budget discovery
- [Mikhail Shilkov - Inside Claude Code Skills](https://mikhail.io/2025/10/claude-code-skills/) - Technical deep dive

### Tertiary (Known bugs - in progress)
- [GitHub Issue #9716](https://github.com/anthropics/claude-code/issues/9716) - Skills not aware bug
- [GitHub Issue #11266](https://github.com/anthropics/claude-code/issues/11266) - Auto-discovery bug
- [GitHub Issue #14733](https://github.com/anthropics/claude-code/issues/14733) - /skills display bug
</sources>

<metadata>
## Metadata

**Research scope:**
- Core technology: Claude Code skill system
- Ecosystem: YAML frontmatter, progressive disclosure, trigger matching
- Patterns: Directory structure, description writing, reference files
- Pitfalls: Multi-line YAML, character budget, vague descriptions

**Confidence breakdown:**
- Standard stack: HIGH - verified with official repo and docs
- Architecture: HIGH - from official best practices
- Pitfalls: HIGH - multiple sources confirm same issues
- Code examples: HIGH - from official sources and verified fixes

**Research date:** 2026-01-13
**Valid until:** 2026-02-13 (30 days - skill system stable)
</metadata>

---

*Phase: 3.1-skills-deep-dive*
*Research completed: 2026-01-13*
*Ready for planning: yes*
