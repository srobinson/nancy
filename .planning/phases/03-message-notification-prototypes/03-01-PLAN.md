<!-- b_path:: .planning/phases/03-message-notification-prototypes/03-01-PLAN.md -->
---
phase: 03-message-notification-prototypes
plan: 01
type: execute
domain: bash
---

<objective>
Create tmux notification module with display-message and display-popup primitives.

Purpose: Establish the notification API that can be called when messages arrive, providing both non-blocking (display-message) and blocking (display-popup) notification mechanisms.
Output: `src/notify/` module with tmux notification functions ready for integration with file watcher.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior phase context:**
@.planning/phases/01-comms-directory-redesign/01-01-SUMMARY.md
@.planning/phases/02-worker-outbound-messages/02-01-SUMMARY.md

**Research:**
@.planning/phases/03-message-notification-prototypes/03-RESEARCH.md

**Relevant source files:**
@src/comms/comms.sh
@src/cmd/internal.sh

**Tech stack available:**

- Inbox/outbox IPC pattern from Phase 1
- Worker/orchestrator message flow from Phase 2
- tmux 3.6+ (already required by Nancy)

**Constraining decisions:**

- [Phase 1]: Message format is markdown with Type, From, Priority, Time headers
- [Phase 2]: Worker messages arrive in `comms/orchestrator/inbox/`

**From RESEARCH.md - Don't hand-roll:**

- Cross-pane messaging: Use tmux display-message (built into tmux, reliable)
- Persistent popup: Use tmux display-popup (native, handles terminal resize)
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Create notify module with index loader</name>
  <files>src/notify/index.sh</files>
  <action>
Create notify module directory and index.sh that sources all notification submodules.

Structure:

```
src/notify/
├── index.sh    # Module loader (this task)
└── tmux.sh     # tmux notification functions (task 2)
```

index.sh should:

- Source tmux.sh
- Export the module pattern matching other Nancy modules (see src/comms/index.sh)
- Include header comment with b_path marker

Follow existing module pattern from src/comms/index.sh.
</action>
<verify>source src/notify/index.sh succeeds without error</verify>
<done>notify module loads without errors, matches existing module patterns</done>
</task>

<task type="auto">
  <name>Task 2: Create tmux.sh with notification functions</name>
  <files>src/notify/tmux.sh</files>
  <action>
Create tmux notification functions:

1. `notify::message <target_pane> <message> [delay_ms]`

   - Uses `tmux display-message -t "$target_pane" -d "$delay_ms" "$message"`
   - Default delay: 5000ms (5 seconds)
   - Non-blocking, shows in status line
   - Returns immediately

2. `notify::popup <target_pane> <title> <content_file>`

   - Uses `tmux display-popup -t "$target_pane" -T "$title" -w 70% -h 40% -E "cat '$content_file'; echo; read -n1 -p 'Press any key...'"`
   - Blocking - user must dismiss
   - For urgent/blocking messages only

3. `notify::bell <target_pane>`

   - Sends ASCII BEL character via `tmux send-keys -t "$target_pane" "$(printf '\a')"`
   - Alternative: `tmux send-keys -t "$target_pane" BEL` (tmux key name)
   - Triggers tmux bell alert if configured

4. `notify::worker_message <task> <message_file>`
   - High-level function for notifying orchestrator of worker message
   - Reads message file, extracts Type and Priority headers
   - If Priority=urgent: uses notify::popup
   - Otherwise: uses notify::message with message type in status line
   - Target pane: "nancy-${task}.0" (orchestrator pane)

Include validation:

- Check TMUX env var is set (error if not in tmux)
- Check target pane exists via `tmux list-panes -t "$target_pane" 2>/dev/null`

Header comment should include b_path marker and function documentation.
</action>
<verify>
source src/notify/index.sh && type notify::message && type notify::popup && type notify::bell && type notify::worker_message
</verify>
<done>All four functions defined, sourcing succeeds, function signatures match spec</done>
</task>

<task type="auto">
  <name>Task 3: Add notify module to Nancy core loader</name>
  <files>src/core/index.sh</files>
  <action>
Add notify module to core loader so it's available throughout Nancy.

Find the module loading section in src/core/index.sh (likely sources comms, config, etc.) and add:

```bash
source "$NANCY_FRAMEWORK_ROOT/src/notify/index.sh"
```

Place it after comms module since notify depends on comms patterns.

DO NOT restructure existing loading order - just add notify module.
</action>
<verify>
source nancy && type notify::message && type notify::worker_message
</verify>
<done>notify module loads as part of Nancy core, functions accessible globally</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `source src/notify/index.sh` succeeds
- [ ] `notify::message`, `notify::popup`, `notify::bell`, `notify::worker_message` are defined
- [ ] Functions validate TMUX environment
- [ ] notify module loads via Nancy core (source nancy)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors in module loading
- tmux notification primitives ready for file watcher integration
  </success_criteria>

<output>
After completion, create `.planning/phases/03-message-notification-prototypes/03-01-SUMMARY.md`
</output>
