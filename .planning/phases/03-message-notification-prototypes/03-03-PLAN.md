<!-- b_path:: .planning/phases/03-message-notification-prototypes/03-03-PLAN.md -->
---
phase: 03-message-notification-prototypes
plan: 03
type: execute
domain: bash
---

<objective>
Integrate notification system with orchestration and test end-to-end message flow.

Purpose: Wire up the notification prototypes to actual orchestration, test with real worker messages, and document findings for Phase 4 (Logs pane as message relay).
Output: Updated orchestrate.sh to use _logs_v2, tested notification flow, documented evaluation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior plans in this phase:**
@.planning/phases/03-message-notification-prototypes/03-01-PLAN.md
@.planning/phases/03-message-notification-prototypes/03-02-PLAN.md

**Research:**
@.planning/phases/03-message-notification-prototypes/03-RESEARCH.md

**Relevant source files:**
@src/notify/index.sh
@src/notify/tmux.sh
@src/notify/watcher.sh
@src/cmd/internal.sh
@src/cmd/orchestrate.sh

**From roadmap Phase 3 scope:**
- Evaluate each for reliability and UX
- Select best approach or combination
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update orchestrate.sh to optionally use _logs_v2</name>
  <files>src/cmd/orchestrate.sh</files>
  <action>
Update the Logs pane command in orchestrate.sh to use _logs_v2 instead of _logs.

Find the line (around line 76):
```bash
tmux send-keys -t "$win.2" "cd '$cwd' && '$NANCY_FRAMEWORK_ROOT/nancy' _logs '$task'; echo '[Press Enter to exit]'; read" C-m
```

Change to:
```bash
tmux send-keys -t "$win.2" "cd '$cwd' && '$NANCY_FRAMEWORK_ROOT/nancy' _logs_v2 '$task'; echo '[Press Enter to exit]'; read" C-m
```

Also update the pane title (around line 64):
```bash
tmux select-pane -t "$win.2" -T "ðŸ“¬ Messages" 2>/dev/null || true
```

This makes the Logs pane act as message relay by default. If fswatch is missing, _logs_v2 falls back to _logs automatically.
  </action>
  <verify>grep -q "_logs_v2" src/cmd/orchestrate.sh</verify>
  <done>orchestrate.sh uses _logs_v2 for Logs pane</done>
</task>

<task type="auto">
  <name>Task 2: Create test script for notification flow</name>
  <files>scripts/test-notify.sh</files>
  <action>
Create a test script that validates the notification system works:

```bash
#!/usr/bin/env bash
# Test notification system end-to-end
# Run from project root: ./scripts/test-notify.sh

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Source Nancy
source "$PROJECT_ROOT/nancy"

echo "=== Notification System Test ==="
echo ""

# Test 1: Check fswatch
echo "1. Checking fswatch..."
if notify::check_fswatch; then
    echo "   âœ“ fswatch available"
else
    echo "   âœ— fswatch NOT available"
    echo "   Install with: brew install fswatch"
    exit 1
fi

# Test 2: Check tmux
echo "2. Checking tmux environment..."
if [[ -n "${TMUX:-}" ]]; then
    echo "   âœ“ Running in tmux"
else
    echo "   âœ— NOT in tmux (some tests will be skipped)"
fi

# Test 3: Test notify functions exist
echo "3. Checking notify functions..."
for fn in notify::message notify::popup notify::bell notify::worker_message notify::watch_inbox; do
    if type "$fn" &>/dev/null; then
        echo "   âœ“ $fn"
    else
        echo "   âœ— $fn NOT found"
        exit 1
    fi
done

# Test 4: Create test message and verify reading
echo "4. Testing message file handling..."
TEST_DIR=$(mktemp -d)
TEST_MSG="$TEST_DIR/20260113T120000Z-001.md"
cat > "$TEST_MSG" << 'EOF'
# Message

**Type:** progress
**From:** worker
**Priority:** normal
**Time:** 2026-01-13T12:00:00Z

## Content

Test message for notification system.
EOF

if [[ -f "$TEST_MSG" ]]; then
    echo "   âœ“ Test message created"
    TYPE=$(grep "^\*\*Type:\*\*" "$TEST_MSG" | sed 's/.*\*\* //')
    echo "   âœ“ Extracted type: $TYPE"
else
    echo "   âœ— Failed to create test message"
    exit 1
fi

# Cleanup
rm -rf "$TEST_DIR"

echo ""
echo "=== All tests passed ==="
echo ""
echo "To test live notification:"
echo "1. Start orchestration: nancy orchestrate <task>"
echo "2. In worker pane, run: /send-message"
echo "3. Watch for notification in orchestrator pane"
```

Make executable: chmod +x scripts/test-notify.sh
  </action>
  <verify>test -x scripts/test-notify.sh && ./scripts/test-notify.sh</verify>
  <done>Test script runs and passes all checks</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete notification prototype system:
- tmux notification module (display-message, popup, bell)
- fswatch-based file watcher for orchestrator inbox
- Updated orchestration to use message relay mode in Logs pane
  </what-built>
  <how-to-verify>
1. Ensure fswatch is installed: `brew install fswatch` (if not already)
2. Start a test orchestration session:
   ```bash
   cd /Users/alphab/Dev/LLM/DEV/TMP/nancy
   source nancy
   nancy orchestrate test-task  # or any existing task
   ```
3. In the **worker pane** (top right), have Claude use `/send-message` skill to send a test message
4. Verify in **Messages pane** (bottom right):
   - Shows "Watching for worker messages..."
   - When message sent, displays the event
5. Verify in **Orchestrator pane** (left):
   - tmux status line shows notification briefly
6. Test priority levels:
   - Normal priority: status line message (non-blocking)
   - Urgent priority: should show popup (blocking)
  </how-to-verify>
  <resume-signal>Type "approved" if notifications work, or describe what's broken</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] orchestrate.sh uses _logs_v2
- [ ] test-notify.sh exists and passes
- [ ] Human verified live notification flow works
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Human verified notification flow
- Phase 3 complete, ready for Phase 4
</success_criteria>

<output>
After completion, create `.planning/phases/03-message-notification-prototypes/03-03-SUMMARY.md` with:
- Evaluation of notification approaches
- Recommended approach for Phase 4
- Any issues or limitations discovered
</output>
