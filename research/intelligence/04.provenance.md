# Provenance Metadata in Assembled Prompts

**Date**: 2026-01-24

---

## Concept

Include rich metadata in assembled prompts that tracks:
- Which fragments were used
- Which beads provided data
- What was detected (language, framework, etc.)
- When it was assembled
- How to reproduce it
- Where to edit source files

---

## Benefits

### 1. **Traceability**
Know exactly what went into a prompt. "This section came from `core.principles.md` version 1.0.0"

### 2. **Debuggability**
When a prompt isn't working, see which fragment is the issue and jump directly to source file.

### 3. **Version Control**
Track which version of each fragment was used. Detect when fragments change.

### 4. **Easy Modification**
See "this section is from `eng.lang.typescript.md`" → edit that file → reassemble.

### 5. **Reproducibility**
Given the same beads + fragments + context, recreate the exact same prompt.

### 6. **Change Detection**
Hash changes indicate fragment modifications. Know when to invalidate cache.

---

## Design: Hybrid Approach

**Header**: Rich YAML metadata
**Inline**: Fragment boundary markers

```markdown
---
provenance:
  assembler:
    name: task-init
    version: 1.0
    file: templates/assemblers/task-init.yaml

  context:
    user: Stuart
    project: nancy-bubble-gum
    detected:
      language: typescript
      framework: react
    git:
      worktrees: true
      branch: main

  fragments:
    - id: core.principles
      domain: core
      file: templates/fragments/core.principles.md
      version: 1.0.0
      priority: 0
      hash: a4f3b2c1d5e6f7a8
      size_bytes: 1024

    - id: user.identity
      domain: user
      file: templates/fragments/user.identity.md
      version: 1.0.0
      priority: 10
      hash: d5e6f7a8b9c0d1e2
      size_bytes: 512

    - id: eng.lang.typescript
      domain: eng
      file: templates/fragments/eng.lang.typescript.md
      version: 1.0.0
      priority: 50
      hash: b9c0d1e2f3a4b5c6
      size_bytes: 2048

  beads:
    - file: beads/user.yaml
      hash: f3a4b5c6d7e8f9a0
    - file: beads/project.nancy-bubble-gum.yaml
      hash: a8b9c0d1e2f3a4b5
    - file: beads/style.eng.typescript.yaml
      hash: e2f3a4b5c6d7e8f9

  assembled_at: 2026-01-24T15:30:00Z
  nancy_version: 0.1.0
  cache_key: hash(assembler + context + fragments + beads)
  total_fragments: 5
  total_size_bytes: 4096
---

<!-- BEGIN: core.principles | priority: 0 | templates/fragments/core.principles.md -->
# Core Principles

## Professional Objectivity
- Prioritize technical accuracy over validation
...
<!-- END: core.principles -->

<!-- BEGIN: user.identity | priority: 10 | templates/fragments/user.identity.md -->
# Working Context

You are working with **Stuart**, Senior Developer.
...
<!-- END: user.identity -->

<!-- BEGIN: eng.lang.typescript | priority: 50 | templates/fragments/eng.lang.typescript.md -->
# TypeScript Guidelines

## Project Style Configuration
...
<!-- END: eng.lang.typescript -->
```

---

## Metadata Structure

### Top-Level Fields

```yaml
provenance:
  assembler:          # Which assembler was used
    name: string
    version: string
    file: path

  context:            # What was detected/available
    user: string | null
    project: string | null
    detected:
      language: string | array
      framework: string | array
    git:
      worktrees: boolean
      branch: string
    custom: any        # Domain-specific context

  fragments:          # List of fragments (in priority order)
    - id: string
      domain: string
      category: string
      name: string
      file: path
      version: semver
      priority: number
      hash: sha256
      size_bytes: number

  beads:              # List of beads used
    - file: path
      hash: sha256
      modified_at: timestamp (optional)

  assembled_at: ISO8601 timestamp
  nancy_version: semver
  cache_key: hash
  total_fragments: number
  total_size_bytes: number
```

---

## Use Cases

### 1. Debugging a Prompt

**Problem**: "The TypeScript guidelines are too strict for this POC project"

**Solution**:
1. Look at provenance → see `eng.lang.typescript` fragment
2. Check file: `templates/fragments/eng.lang.typescript.md`
3. See conditional logic checking `beads.style.typescript.mode`
4. Edit bead: `beads/style.eng.typescript.yaml` → set `mode: "poc"`
5. Reassemble → problem solved

### 2. Understanding Changes

**Problem**: "Why did my prompt change?"

**Solution**:
1. Compare cache keys (hashes changed)
2. Look at fragment hashes
3. See `eng.lang.typescript` hash changed from `abc123` to `def456`
4. Check git log for that file
5. See what changed and why

### 3. Reproducing Production Prompt

**Problem**: "Need to reproduce exact prompt from production"

**Solution**:
1. Get provenance metadata from production log
2. Checkout nancy version: `0.1.0`
3. Restore beads to exact hashes
4. Restore fragments to exact hashes (or versions)
5. Run assembler → identical prompt

### 4. Fragment Impact Analysis

**Problem**: "If I change `core.principles.md`, which prompts are affected?"

**Solution**:
1. Search assembled prompts for `core.principles` in provenance
2. See all prompts using this fragment
3. Test changes in staging
4. Roll out with confidence

### 5. Performance Optimization

**Problem**: "Prompt is too large, need to reduce tokens"

**Solution**:
1. Look at `total_size_bytes` in provenance
2. See fragments sorted by `size_bytes`
3. Identify largest fragments
4. Evaluate if they're necessary for this context
5. Conditionally exclude or trim them

---

## Implementation Details

### Hash Calculation

```typescript
function hashFragment(fragmentPath: string): string {
  const content = fs.readFileSync(fragmentPath, 'utf8')
  return crypto.createHash('sha256').update(content).digest('hex').slice(0, 16)
}

function hashBead(beadPath: string): string {
  const content = fs.readFileSync(beadPath, 'utf8')
  return crypto.createHash('sha256').update(content).digest('hex').slice(0, 16)
}

function calculateCacheKey(provenance: Provenance): string {
  const data = JSON.stringify({
    assembler: provenance.assembler,
    context: provenance.context,
    fragments: provenance.fragments.map(f => ({ id: f.id, hash: f.hash })),
    beads: provenance.beads.map(b => ({ file: b.file, hash: b.hash }))
  })
  return crypto.createHash('sha256').update(data).digest('hex').slice(0, 32)
}
```

### Inline Markers

```typescript
function wrapFragmentContent(fragment: Fragment, content: string): string {
  const header = `<!-- BEGIN: ${fragment.id} | priority: ${fragment.priority} | ${fragment.file} -->`
  const footer = `<!-- END: ${fragment.id} -->`
  return `${header}\n${content}\n${footer}`
}
```

### Assembly with Provenance

```typescript
function assemblePrompt(assembler: Assembler, context: Context): AssembledPrompt {
  // Select and load fragments
  const fragments = selectFragments(assembler, context)

  // Build provenance metadata
  const provenance: Provenance = {
    assembler: {
      name: assembler.name,
      version: assembler.version,
      file: assembler.filePath
    },
    context: context,
    fragments: fragments.map(f => ({
      id: f.id,
      domain: f.domain,
      category: f.category,
      name: f.name,
      file: f.filePath,
      version: f.version,
      priority: f.priority,
      hash: hashFragment(f.filePath),
      size_bytes: f.content.length
    })),
    beads: context.beadsUsed.map(b => ({
      file: b.path,
      hash: hashBead(b.path)
    })),
    assembled_at: new Date().toISOString(),
    nancy_version: NANCY_VERSION,
    total_fragments: fragments.length,
    total_size_bytes: fragments.reduce((sum, f) => sum + f.content.length, 0)
  }

  provenance.cache_key = calculateCacheKey(provenance)

  // Assemble content with inline markers
  const sections = fragments.map(f =>
    wrapFragmentContent(f, interpolate(f.content, context))
  )

  // Create final prompt
  const prompt = [
    '---',
    yaml.stringify({ provenance }),
    '---',
    '',
    ...sections
  ].join('\n')

  return { prompt, provenance }
}
```

---

## CLI Commands

### Show Provenance

```bash
$ nancy provenance show examples/output/assembled-prompt.md

Assembler: task-init (v1.0)
Assembled: 2026-01-24T15:30:00Z
Nancy Version: 0.1.0

Context:
  User: Stuart
  Project: nancy-bubble-gum
  Language: typescript
  Framework: react

Fragments (5):
  1. core.principles (priority: 0)
     File: templates/fragments/core.principles.md
     Hash: a4f3b2c1d5e6f7a8
     Size: 1024 bytes

  2. user.identity (priority: 10)
     File: templates/fragments/user.identity.md
     Hash: d5e6f7a8b9c0d1e2
     Size: 512 bytes

  (... more ...)

Beads (3):
  - beads/user.yaml (f3a4b5c6d7e8f9a0)
  - beads/project.nancy-bubble-gum.yaml (a8b9c0d1e2f3a4b5)
  - beads/style.eng.typescript.yaml (e2f3a4b5c6d7e8f9)

Cache Key: a4f3b2c1d5e6f7a8b9c0d1e2f3a4b5c6
Total Size: 4096 bytes
```

### Diff Prompts

```bash
$ nancy provenance diff prompt1.md prompt2.md

Differences:

Fragments Added:
  + eng.framework.nextjs (priority: 65)

Fragments Removed:
  - eng.framework.react (priority: 60)

Fragments Changed:
  ~ eng.lang.typescript
    Old hash: a4f3b2c1d5e6f7a8
    New hash: d5e6f7a8b9c0d1e2
    File: templates/fragments/eng.lang.typescript.md

Beads Changed:
  ~ beads/style.eng.typescript.yaml
    Old hash: f3a4b5c6d7e8f9a0
    New hash: a8b9c0d1e2f3a4b5
```

### Find Prompts Using Fragment

```bash
$ nancy provenance find-using core.principles

Found 47 assembled prompts using core.principles:

examples/output/assembled-prompt.md
  Assembled: 2026-01-24T15:30:00Z
  Fragment version: 1.0.0 (a4f3b2c1d5e6f7a8)

cache/assembled/abc123def456.md
  Assembled: 2026-01-23T10:15:00Z
  Fragment version: 1.0.0 (a4f3b2c1d5e6f7a8)

(... more ...)
```

---

## Advanced: Provenance Query Language

```bash
# Find prompts using TypeScript fragment
$ nancy provenance query "fragments.id == 'eng.lang.typescript'"

# Find prompts assembled today
$ nancy provenance query "assembled_at >= '2026-01-24'"

# Find prompts with more than 5 fragments
$ nancy provenance query "total_fragments > 5"

# Find prompts for specific project
$ nancy provenance query "context.project == 'nancy-bubble-gum'"

# Find prompts using outdated fragment versions
$ nancy provenance query "fragments[].version < '1.1.0'"
```

---

## Security Considerations

### Don't Include Sensitive Data

Provenance should NOT contain:
- User's actual data (just user identifier)
- Project secrets or API keys
- Private code snippets
- Sensitive bead values

✅ Good:
```yaml
context:
  user: Stuart
  project: nancy-bubble-gum
```

❌ Bad:
```yaml
context:
  user:
    name: Stuart
    email: stuart@company.com
    api_key: sk-abc123...
```

### Provenance is Public

Treat provenance metadata as public within your organization. It shows:
- What fragments you're using
- Project names
- Technology choices
- Assembler configurations

This is fine for transparency but don't include secrets.

---

## Summary

Provenance metadata transforms Nancy from a "black box" prompt assembler into a transparent, debuggable, version-controlled system.

**Key Benefits:**
1. **Traceability** - Know what went into every prompt
2. **Debuggability** - Jump from prompt to source
3. **Reproducibility** - Recreate exact prompts
4. **Change tracking** - See what changed and why
5. **Performance analysis** - Identify large fragments
6. **Impact analysis** - Know which prompts use which fragments

**Implementation:**
- YAML frontmatter with rich metadata
- HTML comments for fragment boundaries
- SHA-256 hashes for change detection
- CLI tools for querying and diffing

This makes Nancy production-ready for teams that need to understand, debug, and evolve their AI prompts over time.
